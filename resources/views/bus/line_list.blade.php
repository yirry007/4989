@extends('bus.layout')@section('content')	<div class="search">		<div class="search_wrap">			<div>				<input type="text" list="org" name="org_name" path="list" value="" placeholder="我的位置" oninput="getDes(this, 'org');" />				<ul class="search_line_list" id="org"></ul>				<em></em>			</div>			<div>				<input type="text" list="des" name="des_name" value="" placeholder="输入终点" oninput="getDes(this, 'des');" />				<ul class="search_line_list" id="des"></ul>				<em></em>			</div>			<a href="javascript:void(0);" onclick="search_line(this);">				<img src="<?php echo e(url('public/bus/img/search.png')) ?>" />			</a>		</div>	</div>	<ul class="line_list"></ul>@endsection@section('script')	<script>		$(function(){			$('.search_line_list').on('click', 'li', function(){				$(this).parent('ul').prev('input[type=text]').val($(this).attr('name'));				localStorage.setItem($(this).attr('type'), $(this).attr('val'));				localStorage.setItem($(this).attr('type')+'_name', $(this).attr('name'));				$(this).parent('ul').hide();				$(this).parent('ul').prev('input[type=text]').focus();			});			$(document).keyup(function(event){				if(event.keyCode == 13){					search_line();				}			});			var org = localStorage.getItem('org');			var des = localStorage.getItem('des');			var org_name = localStorage.getItem('org_name');			var des_name = localStorage.getItem('des_name');			$('input[name=org_name]').val(org_name);			$('input[name=des_name]').val(des_name);			AMap.plugin('AMap.Transfer', function() {				var transfer = new AMap.Transfer({					city: city,					policy: AMap.Transfer.NO_SUBWAY,					nightflag: false,					cityd: city,					extensions: 'all',				})				var startLngLat = org.split(',');				var endLngLat = des.split(',');				transfer.search(startLngLat, endLngLat, function (status, result) {					if(status == 'complete'){						var plans = result.plans;						var html = '';						$(plans).each(function(k, v){							var fast = '';							if(k === 0){								fast = '<h4>最快</h4>';							}							html += '\						<li>\							<a href="javascript:void(0);" index="'+k+'" onclick="line_view(this);">\								'+fast+'\								<div class="spend">\									<h2>'+timeTransform(v.time)+'</h2>\									<p>'+v.segments[0].instruction+'</p>\								</div>\								<div class="lines">\									<div>';							var stations = 0;							var bus_index = 0;							$(v.segments).each(function(k1, v1){								if(v1.transit_mode === 'BUS'){									stations += v1.transit.via_stops.length;									if(bus_index !== 0){										html += '<span>&gt;</span>';									}									html += '<p>';									$(v1.transit.lines).each(function(k2, v2){										var bus_name = v2.name.split('路');										if(k2 !== 0){											html += '/';										}										html += bus_name[0] + '路';									});									html += '</p>';									bus_index++;								}							});							html += '\									</div>\									<em></em>\								</div>\								<div class="line_info">'+stations+'站 总距离：'+((v.distance / 1000).toFixed(1))+'km</div>\							</a>\						</li>';						});						$('.line_list').html(html);					}				})			});		});		/**		 * 输入时获取位置列表		 * @param string opt 起点或重点		 */		function getDes (obj, opt) {			var keyword = $(obj).val();			if(keyword === ''){				//localStorage.removeItem(opt);				//localStorage.removeItem(opt+'_name');			}else{				$('#'+opt).show();				AMap.plugin('AMap.Autocomplete', function(){					var autoComplete = new AMap.Autocomplete({						city: adcode					});					autoComplete.search(keyword, function(status, result) {						var html = '';						if(result.info === 'OK'){							var data = result.tips;							$(data).each(function(k, v){								if(v.id === ''){//id为空字符串时该地方为外地									return true;								}								html += '<li type="'+opt+'" val="'+v.location.lng+','+v.location.lat+'" name="'+v.name+'">'+v.name+'</li>';							});							$('#'+opt).html(html);						}					})				});			}		}		/**		 * 重新搜索路线		 * @returns {boolean}		 */		function search_line () {			var org = localStorage.getItem('org');			var des = localStorage.getItem('des');			var org_name = $('input[name=org_name]').val();			var des_name = $('input[name=des_name]').val();			if(!org || org_name === ''){				alert('请输入我的位置');				return false;			}			if(!des || des_name === ''){				alert('请输入终点位置');				return false;			}			var line_history = localStorage.getItem('line_history');			var computed = false;			if(!line_history){				line_history = [];			}else{				line_history = JSON.parse(line_history);			}			//已经有相同的始发点和终点，则不再存储			$(line_history).each(function(k, v){				if(v.org_name === org_name && v.des_name === des_name){					computed = true;					return false;				}			});			if(!computed){				line_history.unshift({org: org, org_name: org_name, des: des, des_name: des_name});				if(line_history.length > 10){					line_history.pop();				}				localStorage.setItem('line_history', JSON.stringify(line_history));			}			window.location.href = '<?php echo e(url('bus/line_list')); ?>';		}		/**		 * 把被点击项的索引存储到 localStorage 后跳转到线路详细页		 * @param obj 被点击项		 */		function line_view (obj) {			var index = $(obj).attr('index');			localStorage.setItem('search_index', index);			window.location.href = '<?php echo e(url('bus/line_view')); ?>';		}		function timeTransform (sec) {			var hour = Math.floor(sec / 3600);			var minute = Math.ceil((sec % 3600) / 60);			if(hour !== 0){				return hour + '小时' + minute + '分钟';			}else{				return minute + '分钟';			}		}	</script>@endsection