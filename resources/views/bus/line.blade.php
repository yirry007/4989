@extends('bus.layout')@section('content')	<div class="tab">		<a href="javascript:void(0);" class="v">公交线路查询</a>		<a href="<?php echo e(url('bus/station')) ?>">公交站点查询</a>	</div>	<div class="search">		<div class="search_wrap">			<div>				<input type="text" name="org_name" value="" path="main" placeholder="我的位置" oninput="getDes(this, 'org');" />				<ul class="search_line_list" id="org"></ul>				<em></em>			</div>			<div>				<input type="text" name="des_name" value="" placeholder="输入终点" oninput="getDes(this, 'des');" />				<ul class="search_line_list" id="des"></ul>				<em></em>			</div>			<a href="javascript:void(0);" onclick="search_line(this);">				<img src="<?php echo e(url('public/bus/img/search.png')) ?>" />			</a>		</div>	</div>	<div class="history">		<div class="history_wrap">			<h3>历史记录（只显示前10条）</h3>			<div id="line_history"></div>			<a href="javascript:void(0);" class="clear" onclick="clearHistory();">清空记录</a>		</div>	</div>@endsection@section('script')	<script>		$(function(){			$('.search_line_list').on('click', 'li', function(){				$(this).parent('ul').prev('input[type=text]').val($(this).attr('name'));				localStorage.setItem($(this).attr('type'), $(this).attr('val'));				localStorage.setItem($(this).attr('type')+'_name', $(this).attr('name'));				$(this).parent('ul').hide();				$(this).parent('ul').prev('input[type=text]').focus();			});			$(document).keyup(function(event){				if(event.keyCode == 13){					search_line();				}			});			var line_history = localStorage.getItem('line_history');			if(!line_history){				line_history = [];			}else{				line_history = JSON.parse(line_history);			}			var html = '';			$(line_history).each(function(k, v){				html += '<a href="javascript:void(0);" org="'+v.org+'" des="'+v.des+'" org_name="'+v.org_name+'" des_name="'+v.des_name+'" onclick="search_line(this, true);">'+v.org_name+' &gt; '+v.des_name+'</a>';			});			$('#line_history').html(html);		});		/**		 * 输入时获取位置列表		 * @param string opt 起点或重点		 */		function getDes (obj, opt) {			var keyword = $(obj).val();			if(keyword === ''){				$('#'+opt).hide();				localStorage.removeItem(opt);				localStorage.removeItem(opt+'_name');			}else{				$('#'+opt).show();				AMap.plugin('AMap.Autocomplete', function(){					var autoComplete = new AMap.Autocomplete({						city: adcode					});					autoComplete.search(keyword, function(status, result) {						var html = '';						if(result.info === 'OK'){							var data = result.tips;							$(data).each(function(k, v){								if(v.id === ''){//id为空字符串时该地方为外地									return true;								}								html += '<li type="'+opt+'" val="'+v.location.lng+','+v.location.lat+'" name="'+v.name+'">'+v.name+'</li>';							});							$('#'+opt).html(html);						}					})				});			}		}		/**		 * 地点存储到 localStorage 后，跳转到列表页		 * @param string is_history 是否点击历史记录		 */		function search_line (obj, is_history) {			if(is_history){				localStorage.setItem('org', $(obj).attr('org'));				localStorage.setItem('des', $(obj).attr('des'));				localStorage.setItem('org_name', $(obj).attr('org_name'));				localStorage.setItem('des_name', $(obj).attr('des_name'));			}			var org = localStorage.getItem('org');			var des = localStorage.getItem('des');			var org_name = $('input[name=org_name]').val();			var des_name = $('input[name=des_name]').val();			if((!org || org_name === '') && !is_history){				alert('请输入我的位置');				return false;			}			if((!des || des_name === '') && !is_history){				alert('请输入终点位置');				return false;			}			if(!is_history){				var line_history = localStorage.getItem('line_history');				var computed = false;				if(!line_history){					line_history = [];				}else{					line_history = JSON.parse(line_history);				}				//已经有相同的始发点和终点，则不再存储				$(line_history).each(function(k, v){					if(v.org_name === org_name && v.des_name === des_name){						computed = true;						return false;					}				});				if(!computed){					line_history.unshift({org: org, org_name: org_name, des: des, des_name: des_name});					if(line_history.length > 10){						line_history.pop();					}					localStorage.setItem('line_history', JSON.stringify(line_history));				}			}			window.location.href = '<?php echo e(url('bus/line_list')); ?>';		}		function clearHistory () {			if(confirm('确定要删除历史记录吗？')){				localStorage.removeItem('line_history');				$('#line_history').html('');			}		}		/**		 * 微信获取当前坐标，并转换为位置		 */		/*		wx.ready(function () {			wx.getLocation({				success: function (res) {					var latitude = res.latitude;					var longitude = res.longitude;					//localStorage.setItem("latitude", latitude);                    //localStorage.setItem("longitude", longitude);					var pos = [longitude, latitude];					setLocation(pos);				},				cancel: function () {					console.log('请手动输入我的位置')				}			});		});		*/		/**		 * 根据坐标获取当前位置		 */		/*		function setLocation (pos) {			var gps = pos;			AMap.convertFrom(gps, 'gps', function (status, result) {//腾讯坐标转换为高德坐标				if (result.info === 'ok') {					var lnglats = result.locations;					var startLngLat = [lnglats[0].lng, lnglats[0].lat];					AMap.plugin('AMap.Geocoder', function() {						var geocoder = new AMap.Geocoder();						geocoder.getAddress(startLngLat, function(status, result) {							if (status === 'complete' && result.info === 'OK') {								console.log(result);							}						})					})					var virtualPos = [[129.513215,42.907676], [129.502996,42.907778], [129.513317,42.912897], [129.509058,42.895533], [129.505828,42.908988], [129.520328,42.907707], [129.511568,42.925303], [129.511932,42.906184], [129.492883,42.907826], [129.516746,42.900918]];					var endLngLat = virtualPos[Math.floor(Math.random()*virtualPos.length)];					AMap.plugin('AMap.Transfer', function() {						var transfer = new AMap.Transfer({							city: '延吉',							policy: AMap.Transfer.NO_SUBWAY,							nightflag: false,							cityd: '延吉',							extensions: 'all',						})						transfer.search(startLngLat, endLngLat, function (status, result) {							if(status == 'complete'){								var plans = result.plans;								var des = [];								//console.log(plans);								//众多的位置中找出出现次数最多的项，并记录到dom								$(plans).each(function(k, v){									var computed = false;									var _currentPos = v.segments[0].instruction;									var currentPosArr = _currentPos.split('到达');									var currentPos = currentPosArr[1];									$(des).each(function(k, v){										if(v.pos === currentPos){											v.count++;											computed = true;											return false;										}									});									if(!computed){										des.push({pos:currentPos, lng:v.segments[0].transit.origin.lng, lat:v.segments[0].transit.origin.lat, count:1});									}								});								var maxIndex = 0;								var maxCount = 1;								$(des).each(function(k, v){									if(v.count > maxCount){										maxIndex = k;									}								});								localStorage.setItem('org', des[maxIndex].lng+','+des[maxIndex].lat);								$('input[name=org_name]').val(des[maxIndex].pos);							}						})					});				}			});		}		*/		/*		AMap.plugin('AMap.Autocomplete', function(){			var autoComplete= new AMap.Autocomplete({				//city 限定城市，默认全国				city: '延吉'			});			autoComplete.search('北大', function(status, result) {				// 搜索成功时，result即是对应的匹配数据				console.log(result);			})		});		*/		/*		AMap.plugin('AMap.Transfer', function() {			var transfer = new AMap.Transfer({				city: '延吉',				policy: AMap.Transfer.NO_SUBWAY,				nightflag: false,				cityd: '延吉',				extensions: 'all',			})			var startLngLat = [129.51019,42.929982]			var endLngLat = [129.513465,42.911706]			transfer.search(startLngLat, endLngLat, function (status, result) {				if(status == 'complete'){					console.log(result)				}else if(status == 'error'){				}else{				}			})		});		*/		/*		AMap.plugin(["AMap.StationSearch"], function() {			//实例化公交站点查询类			var station = new AMap.StationSearch({				pageIndex: 1, //页码，默认值为1				pageSize: 50, //单页显示结果条数，默认值为20，最大值为50				city: '1433' //限定查询城市，可以是城市名（中文/中文全拼）、城市编码，默认值为『全国』			});			//执行关键字查询			station.search('北大', function(status, result) {				//打印状态信息status和结果信息result				//status：complete 表示查询成功，no_data 为查询无结果，error 代表查询错误。				console.log(status, result);			});		});		*/		/*		AMap.plugin(["AMap.LineSearch"], function() {			//实例化公交线路查询类			var linesearch = new AMap.LineSearch({				pageIndex: 1, //页码，默认值为1				pageSize: 1, //单页显示结果条数，默认值为20，最大值为50				city: "延吉", //限定查询城市，可以是城市名（中文/中文全拼）、城市编码，默认值为『全国』				extensions: "all" //是否返回公交线路详细信息，默认值为『base』			});			//执行公交路线关键字查询			linesearch.search('3', function(status, result) {				//打印状态信息status和结果信息result				console.log(status, result);			});		});		*/	</script>@endsection